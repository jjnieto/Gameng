openapi: 3.1.0
info:
  title: Gameng API
  version: 0.0.1
  description: Server-side data-driven RPG engine API

servers:
  - url: http://localhost:3000

tags:
  - name: health
    description: Health check
  - name: config
    description: Game configuration (read-only)
  - name: algorithms
    description: Algorithm catalog discovery
  - name: state
    description: Game state (read-only)
  - name: transaction
    description: State mutation via transactions

paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check
      description: Returns server health status, timestamp, and uptime.
      tags:
        - health
      responses:
        "200":
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - timestamp
                  - uptime
                properties:
                  status:
                    type: string
                    enum:
                      - ok
                  timestamp:
                    type: string
                    format: date-time
                  uptime:
                    type: number
                    description: Server uptime in seconds

  /{gameInstanceId}/config:
    get:
      operationId: getConfig
      summary: Get game configuration
      description: >
        Returns the complete immutable game configuration for the given instance.
        No authentication required (SEMANTICS Decision #16).
      tags:
        - config
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
      responses:
        "200":
          description: Game configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GameConfig"
              example:
                gameConfigId: minimal_v1
                maxLevel: 10
                stats:
                  - strength
                  - hp
                slots:
                  - right_hand
                  - off_hand
                classes:
                  warrior:
                    baseStats:
                      strength: 5
                      hp: 20
                gearDefs:
                  sword_basic:
                    baseStats:
                      strength: 3
                    equipPatterns:
                      - - right_hand
                sets: {}
                algorithms:
                  growth:
                    algorithmId: linear
                    params:
                      perLevelMultiplier: 0.1
                      additivePerLevel:
                        hp: 1
                  levelCostCharacter:
                    algorithmId: flat
                    params: {}
                  levelCostGear:
                    algorithmId: flat
                    params: {}
        "404":
          description: Game instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: INSTANCE_NOT_FOUND
                errorMessage: "Game instance 'unknown' not found."

  /{gameInstanceId}/algorithms:
    get:
      operationId: getAlgorithms
      summary: Get algorithm catalog
      description: >
        Returns the full catalog of available growth and level-cost algorithms
        with descriptions and expected parameters.
        No authentication required (discovery endpoint).
      tags:
        - algorithms
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
      responses:
        "200":
          description: Algorithm catalog
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlgorithmCatalog"
              example:
                growth:
                  flat:
                    description: "Returns base stats as-is (floor). No scaling by level."
                    params: {}
                  linear:
                    description: "Scales stats linearly: base * (1 + perLevelMultiplier * (level-1)) + additivePerLevel * (level-1)."
                    params:
                      perLevelMultiplier: "number — multiplicative scaling factor per level"
                      "additivePerLevel?": "Record<string, number> — optional flat bonus per stat per level"
                  exponential:
                    description: "Scales stats exponentially: base * exponent^(level-1)."
                    params:
                      exponent: "number — exponential base applied per level"
                levelCost:
                  flat:
                    description: "Always returns empty cost (free level-ups)."
                    params: {}
                  free:
                    description: "Alias for flat — free level-ups."
                    params: {}
                  linear_cost:
                    description: "cost = base + perLevel * (targetLevel - 2). Single resource."
                    params:
                      resourceId: "string — resource key to charge"
                      base: "number — base cost at level 2"
                      perLevel: "number — additional cost per level above 2"
                  mixed_linear_cost:
                    description: "Multi-resource linear cost with scoped keys (player.*/character.*)."
                    params:
                      costs: "Array<{ scope: 'player'|'character', resourceId: string, base: number, perLevel: number }>"
        "404":
          description: Game instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: INSTANCE_NOT_FOUND
                errorMessage: "Game instance 'unknown' not found."

  /{gameInstanceId}/stateVersion:
    get:
      operationId: getStateVersion
      summary: Get current state version
      description: Returns only the gameInstanceId and current stateVersion. Lightweight polling endpoint.
      tags:
        - state
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
      responses:
        "200":
          description: Current state version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StateVersionResponse"
              example:
                gameInstanceId: instance_001
                stateVersion: 42
        "404":
          description: Game instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: INSTANCE_NOT_FOUND
                errorMessage: "Game instance 'unknown' not found."

  /{gameInstanceId}/tx:
    post:
      operationId: submitTransaction
      summary: Submit a transaction
      description: >
        Submit an atomic command to mutate game state. Returns 200 with the
        result regardless of whether the transaction was accepted or rejected.
        Domain errors are reported via `accepted: false` and `errorCode` in the
        response body. Returns 400 only for malformed or unparseable request bodies.
        CreateActor, GrantResources, and GrantCharacterResources require the ADMIN_API_KEY via Bearer token;
        all other transaction types require a valid actor Bearer token.
        Idempotent by txId: if the same txId is submitted again, the cached
        response is returned without re-executing the transaction.
      tags:
        - transaction
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Transaction"
            example:
              txId: tx_001
              type: CreatePlayer
              gameInstanceId: instance_001
              playerId: player_1
      responses:
        "200":
          description: Transaction processed (check `accepted` field for outcome)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResult"
              examples:
                accepted:
                  summary: Transaction accepted
                  value:
                    txId: tx_001
                    accepted: true
                    stateVersion: 1
                rejected:
                  summary: Transaction rejected
                  value:
                    txId: tx_002
                    accepted: false
                    stateVersion: 0
                    errorCode: PLAYER_NOT_FOUND
                    errorMessage: "Player 'player_99' not found."
                unsupported_type:
                  summary: Unsupported transaction type
                  value:
                    txId: tx_003
                    accepted: false
                    stateVersion: 0
                    errorCode: UNSUPPORTED_TX_TYPE
                    errorMessage: "Transaction type 'DeletePlayer' is not yet supported."
        "400":
          description: Malformed request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid Bearer token. For CreateActor and GrantResources, the ADMIN_API_KEY is required. For all other types, a valid actor token is required.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missing_token:
                  summary: No Authorization header
                  value:
                    errorCode: UNAUTHORIZED
                    errorMessage: "Missing or invalid Bearer token."
                invalid_admin_key:
                  summary: CreateActor with non-admin token
                  value:
                    errorCode: UNAUTHORIZED
                    errorMessage: "Missing or invalid admin API key."
        "404":
          description: Game instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: INSTANCE_NOT_FOUND
                errorMessage: "Game instance 'unknown' not found."

  /{gameInstanceId}/state/player/{playerId}:
    get:
      operationId: getPlayerState
      summary: Get player state
      description: Returns the full player sub-object from the game state, including characters and gear. Requires authentication and ownership of the player.
      tags:
        - state
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
        - $ref: "#/components/parameters/playerId"
      responses:
        "200":
          description: Player state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Player"
              example:
                characters:
                  char_1:
                    classId: warrior
                    level: 3
                    equipped:
                      right_hand: gear_1
                gear:
                  gear_1:
                    gearDefId: sword_basic
                    level: 2
                    equippedBy: char_1
        "404":
          description: Game instance or player not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                instance_not_found:
                  summary: Game instance not found
                  value:
                    errorCode: INSTANCE_NOT_FOUND
                    errorMessage: "Game instance 'unknown' not found."
                player_not_found:
                  summary: Player not found
                  value:
                    errorCode: PLAYER_NOT_FOUND
                    errorMessage: "Player 'nobody' not found."
        "401":
          description: Missing or invalid Bearer token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: UNAUTHORIZED
                errorMessage: "Missing or invalid Bearer token."
        "403":
          description: Authenticated actor does not own the target player
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: OWNERSHIP_VIOLATION
                errorMessage: "Actor does not own player 'player_1'."

  /{gameInstanceId}/character/{characterId}/stats:
    get:
      operationId: getCharacterStats
      summary: Get computed character stats
      description: Returns the final calculated stats for a character, combining base class stats, gear, set bonuses, and growth scaling. Requires authentication and ownership of the character's player.
      tags:
        - state
      security:
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/gameInstanceId"
        - $ref: "#/components/parameters/characterId"
      responses:
        "200":
          description: Computed character stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CharacterStats"
              example:
                characterId: char_1
                classId: warrior
                level: 3
                finalStats:
                  strength: 12
                  hp: 45
        "404":
          description: Game instance or character not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                instance_not_found:
                  summary: Game instance not found
                  value:
                    errorCode: INSTANCE_NOT_FOUND
                    errorMessage: "Game instance 'unknown' not found."
                character_not_found:
                  summary: Character not found
                  value:
                    errorCode: CHARACTER_NOT_FOUND
                    errorMessage: "Character 'char_99' not found."
        "401":
          description: Missing or invalid Bearer token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: UNAUTHORIZED
                errorMessage: "Missing or invalid Bearer token."
        "403":
          description: Authenticated actor does not own the character's player
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                errorCode: OWNERSHIP_VIOLATION
                errorMessage: "Actor does not own player 'player_1'."

components:
  parameters:
    gameInstanceId:
      name: gameInstanceId
      in: path
      required: true
      description: Unique identifier for the game instance
      schema:
        type: string
        minLength: 1

    playerId:
      name: playerId
      in: path
      required: true
      description: Unique identifier for the player
      schema:
        type: string
        minLength: 1

    characterId:
      name: characterId
      in: path
      required: true
      description: Unique identifier for the character
      schema:
        type: string
        minLength: 1

  schemas:
    # -- Error --

    ErrorResponse:
      type: object
      required:
        - errorCode
        - errorMessage
      properties:
        errorCode:
          type: string
          minLength: 1
        errorMessage:
          type: string

    # -- Config domain --

    StatMap:
      type: object
      additionalProperties:
        type: number
      description: Map of statId to numeric value. Missing stats default to 0.

    ClassDef:
      type: object
      required:
        - baseStats
      additionalProperties: false
      properties:
        baseStats:
          $ref: "#/components/schemas/StatMap"

    GearRestrictions:
      type: object
      additionalProperties: false
      not:
        required:
          - allowedClasses
          - blockedClasses
      properties:
        allowedClasses:
          type: array
          items:
            type: string
            minLength: 1
          uniqueItems: true
          description: If present, only these classIds may equip this gear.
        blockedClasses:
          type: array
          items:
            type: string
            minLength: 1
          uniqueItems: true
          description: If present, these classIds may NOT equip this gear.
        requiredCharacterLevel:
          type: integer
          minimum: 1
          description: Character must be at least this level to equip.
        maxLevelDelta:
          type: integer
          minimum: 0
          description: gearLevel must be <= characterLevel + maxLevelDelta.

    GearDef:
      type: object
      required:
        - baseStats
        - equipPatterns
      additionalProperties: false
      properties:
        baseStats:
          $ref: "#/components/schemas/StatMap"
        equipPatterns:
          type: array
          items:
            type: array
            items:
              type: string
              minLength: 1
            minItems: 1
          minItems: 1
          description: Each sub-array is a valid slot occupation pattern.
        setId:
          type: string
          minLength: 1
          description: Optional reference to a set this gear belongs to.
        restrictions:
          $ref: "#/components/schemas/GearRestrictions"
        setPieceCount:
          type: integer
          enum:
            - 1
            - 2
          default: 1
          description: How many set pieces this gear counts as. Default 1.

    StatClamp:
      type: object
      additionalProperties: false
      properties:
        min:
          type: number
          description: Floor value for this stat.
        max:
          type: number
          description: Ceiling value for this stat.

    SetBonus:
      type: object
      required:
        - pieces
        - bonusStats
      additionalProperties: false
      properties:
        pieces:
          type: integer
          minimum: 2
          description: Number of equipped set pieces required to activate this bonus.
        bonusStats:
          $ref: "#/components/schemas/StatMap"

    SetDef:
      type: object
      required:
        - bonuses
      additionalProperties: false
      properties:
        bonuses:
          type: array
          items:
            $ref: "#/components/schemas/SetBonus"
          minItems: 1
          description: Threshold-based bonuses (e.g. 2 pieces, 4 pieces).

    AlgorithmRef:
      type: object
      required:
        - algorithmId
      additionalProperties: false
      properties:
        algorithmId:
          type: string
          minLength: 1
        params:
          type: object
          description: Algorithm-specific parameters. Structure depends on algorithmId.

    Algorithms:
      type: object
      required:
        - growth
        - levelCostCharacter
        - levelCostGear
      additionalProperties: false
      properties:
        growth:
          $ref: "#/components/schemas/AlgorithmRef"
          description: Algorithm for scaling stats by level.
        levelCostCharacter:
          $ref: "#/components/schemas/AlgorithmRef"
          description: Algorithm for character level-up cost.
        levelCostGear:
          $ref: "#/components/schemas/AlgorithmRef"
          description: Algorithm for gear level-up cost.

    GameConfig:
      type: object
      required:
        - gameConfigId
        - maxLevel
        - stats
        - slots
        - classes
        - gearDefs
        - sets
        - algorithms
      additionalProperties: false
      properties:
        gameConfigId:
          type: string
          minLength: 1
        maxLevel:
          type: integer
          minimum: 1
          description: Global max level for both characters and gear.
        stats:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 1
          uniqueItems: true
          description: Catalogue of statIds used across the game.
        slots:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 1
          uniqueItems: true
          description: Catalogue of equipment slotIds.
        classes:
          type: object
          minProperties: 1
          additionalProperties:
            $ref: "#/components/schemas/ClassDef"
          description: Map of classId to class definition.
        gearDefs:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/GearDef"
          description: Map of gearDefId to gear definition.
        sets:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/SetDef"
          description: Map of setId to set definition.
        algorithms:
          $ref: "#/components/schemas/Algorithms"
        statClamps:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/StatClamp"
          description: Optional per-stat min/max clamp applied after final stat calculation.

    # -- State domain --

    Character:
      type: object
      required:
        - classId
        - level
        - equipped
      additionalProperties: false
      properties:
        classId:
          type: string
          minLength: 1
        level:
          type: integer
          minimum: 1
        equipped:
          type: object
          additionalProperties:
            type: string
            minLength: 1
          description: Map of slotId to gearId. Empty slots are absent.
        resources:
          type: object
          additionalProperties:
            type: number
          description: Map of resourceId to amount. Per-character resources (e.g. xp). Optional.

    GearInstance:
      type: object
      required:
        - gearDefId
        - level
      additionalProperties: false
      properties:
        gearDefId:
          type: string
          minLength: 1
        level:
          type: integer
          minimum: 1
        equippedBy:
          type:
            - string
            - "null"
          description: characterId if equipped, null or absent if in inventory.

    Player:
      type: object
      required:
        - characters
        - gear
      additionalProperties: false
      properties:
        characters:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Character"
          description: Map of characterId to character data.
        gear:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/GearInstance"
          description: Map of gearId to gear instance data (inventory + equipped).
        resources:
          type: object
          additionalProperties:
            type: number
          description: Map of resourceId to amount. Optional.

    # -- Transaction domain --

    Transaction:
      type: object
      required:
        - txId
        - type
        - gameInstanceId
      additionalProperties: false
      properties:
        txId:
          type: string
          minLength: 1
          description: Unique transaction identifier (for idempotency).
        type:
          type: string
          enum:
            - CreateActor
            - CreatePlayer
            - CreateCharacter
            - CreateGear
            - LevelUpCharacter
            - LevelUpGear
            - EquipGear
            - UnequipGear
            - GrantResources
            - GrantCharacterResources
        gameInstanceId:
          type: string
          minLength: 1
        playerId:
          type: string
          minLength: 1
        actorId:
          type: string
          minLength: 1
          description: Required for CreateActor.
        apiKey:
          type: string
          minLength: 1
          description: Required for CreateActor.
        classId:
          type: string
          minLength: 1
          description: Required for CreateCharacter.
        characterId:
          type: string
          minLength: 1
          description: Required for CreateCharacter, LevelUpCharacter, EquipGear. Optional hint for UnequipGear.
        gearDefId:
          type: string
          minLength: 1
          description: Required for CreateGear.
        gearId:
          type: string
          minLength: 1
          description: Required for LevelUpGear, EquipGear, UnequipGear.
        slotPattern:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 1
          description: Optional for EquipGear — which occupation pattern to use.
        swap:
          type: boolean
          description: Optional for EquipGear — if true, use swap mode instead of strict mode.
        levels:
          type: integer
          minimum: 1
          description: Optional for LevelUpCharacter / LevelUpGear — number of levels to gain. Default 1.
        resources:
          type: object
          additionalProperties:
            type: number
          description: Required for GrantResources — map of resourceId to amount.
      allOf:
        - if:
            not:
              properties:
                type:
                  const: CreateActor
              required:
                - type
          then:
            required:
              - playerId
        - if:
            properties:
              type:
                const: CreateActor
            required:
              - type
          then:
            required:
              - actorId
              - apiKey
        - if:
            properties:
              type:
                const: CreateCharacter
            required:
              - type
          then:
            required:
              - classId
              - characterId
        - if:
            properties:
              type:
                const: CreateGear
            required:
              - type
          then:
            required:
              - gearDefId
              - gearId
        - if:
            properties:
              type:
                const: LevelUpCharacter
            required:
              - type
          then:
            required:
              - characterId
        - if:
            properties:
              type:
                const: LevelUpGear
            required:
              - type
          then:
            required:
              - gearId
        - if:
            properties:
              type:
                const: EquipGear
            required:
              - type
          then:
            required:
              - gearId
              - characterId
        - if:
            properties:
              type:
                const: UnequipGear
            required:
              - type
          then:
            required:
              - gearId
        - if:
            properties:
              type:
                const: GrantResources
            required:
              - type
          then:
            required:
              - playerId
              - resources
        - if:
            properties:
              type:
                const: GrantCharacterResources
            required:
              - type
          then:
            required:
              - playerId
              - characterId
              - resources

    TransactionResult:
      type: object
      required:
        - txId
        - accepted
        - stateVersion
      additionalProperties: false
      properties:
        txId:
          type: string
          minLength: 1
        accepted:
          type: boolean
        stateVersion:
          type: integer
          minimum: 0
          description: State version after processing (same as before if rejected).
        errorCode:
          type: string
          minLength: 1
          description: Present when accepted is false.
        errorMessage:
          type: string
          description: Human-readable error description.
      if:
        properties:
          accepted:
            const: false
        required:
          - accepted
      then:
        required:
          - errorCode

    # -- New response schemas --

    StateVersionResponse:
      type: object
      required:
        - gameInstanceId
        - stateVersion
      additionalProperties: false
      properties:
        gameInstanceId:
          type: string
          minLength: 1
        stateVersion:
          type: integer
          minimum: 0

    CharacterStats:
      type: object
      required:
        - characterId
        - classId
        - level
        - finalStats
      additionalProperties: false
      properties:
        characterId:
          type: string
          minLength: 1
        classId:
          type: string
          minLength: 1
        level:
          type: integer
          minimum: 1
        finalStats:
          $ref: "#/components/schemas/StatMap"

    AlgorithmMeta:
      type: object
      required:
        - description
        - params
      additionalProperties: false
      properties:
        description:
          type: string
          description: Human-readable description of the algorithm.
        params:
          type: object
          additionalProperties:
            type: string
          description: Map of parameter name to type/description string.

    AlgorithmCatalog:
      type: object
      required:
        - growth
        - levelCost
      additionalProperties: false
      properties:
        growth:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/AlgorithmMeta"
          description: Available growth algorithms.
        levelCost:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/AlgorithmMeta"
          description: Available level-cost algorithms.

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: >
        Bearer token for authentication. For CreateActor transactions, use the
        ADMIN_API_KEY. For all other endpoints, use the actor's apiKey obtained
        via CreateActor.
